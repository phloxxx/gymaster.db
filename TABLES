CREATE DATABASE GYMASTER 
GO

USE GYMASTER
GO 

CREATE TABLE [USER] 
( 
	USER_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, USER_FNAME VARCHAR(50) NOT NULL
	, USER_LNAME VARCHAR(30) NOT NULL
	, USER_FULLNAME AS (USER_FNAME + ' ' + USER_LNAME) PERSISTED
	, USERNAME VARCHAR(20) NOT NULL
	, [PASSWORD] VARCHAR(15) NOT NULL
	, USER_TYPE VARCHAR(10) NOT NULL
	, IS_ACTIVE BIT DEFAULT 1 NOT NULL
	UNIQUE(USERNAME)
 )

CREATE INDEX IDX_USER ON [USER] (USER_FNAME, USER_LNAME)

CREATE TABLE PROGRAM 
( 
	PROGRAM_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, PROGRAM_NAME VARCHAR(50) NOT NULL
	, IS_ACTIVE BIT DEFAULT 1 NOT NULL
)

CREATE TABLE MEMBER 
( 
	MEMBER_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, MEMBER_FNAME VARCHAR(50) NOT NULL
	, MEMBER_LNAME VARCHAR(30) NOT NULL
	, MEMBER_FULLNAME AS (MEMBER_FNAME + ' ' + MEMBER_LNAME) PERSISTED
	, EMAIL VARCHAR(50) NOT NULL
	, PHONE_NUMBER VARCHAR(15) NOT NULL
	, IS_ACTIVE BIT DEFAULT 1 NOT NULL
	, PROGRAM_ID SMALLINT REFERENCES PROGRAM(PROGRAM_ID) NOT NULL
	, USER_ID SMALLINT REFERENCES [USER](USER_ID) NOT NULL	
)

CREATE INDEX IDX_MEM ON MEMBER (MEMBER_FNAME, MEMBER_LNAME)

CREATE TABLE SUBSCRIPTION 
( 
	SUB_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, SUB_NAME VARCHAR(20) NOT NULL
	, DURATION VARCHAR(10) NOT NULL
	, PRICE MONEY NOT NULL
	, IS_ACTIVE BIT DEFAULT 1 NOT NULL
) 

CREATE TABLE MEMBER_SUBSCRIPTION 
( 
    MEMBER_ID SMALLINT NOT NULL
    , SUB_ID SMALLINT NOT NULL
    , START_DATE DATE DEFAULT GETDATE() NOT NULL
    , END_DATE DATE NOT NULL
    , IS_ACTIVE BIT DEFAULT 1 NOT NULL
    , PRIMARY KEY (MEMBER_ID, SUB_ID, START_DATE, END_DATE)
    , FOREIGN KEY (MEMBER_ID) REFERENCES MEMBER(MEMBER_ID)
    , FOREIGN KEY (SUB_ID) REFERENCES SUBSCRIPTION(SUB_ID)	
)

CREATE TABLE COACH 
( 
	COACH_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, COACH_FNAME VARCHAR(50) NOT NULL
	, COACH_LNAME VARCHAR(30) NOT NULL
	, COACH_FULLNAME AS (COACH_FNAME + ' ' + COACH_LNAME) PERSISTED
	, EMAIL VARCHAR(50) NOT NULL
	, PHONE_NUMBER VARCHAR(15) NOT NULL
	, SPECIALIZATION VARCHAR(550) NOT NULL
	, IS_ACTIVE BIT DEFAULT 1 NOT NULL
)

CREATE INDEX IDX_COACH ON COACH(COACH_FNAME, COACH_LNAME)

CREATE TABLE PROGRAM_COACH
( 
	PROGRAM_ID SMALLINT NOT NULL
	, COACH_ID SMALLINT NOT NULL
	, PRIMARY KEY (PROGRAM_ID, COACH_ID)  
	, FOREIGN KEY (PROGRAM_ID) REFERENCES PROGRAM(PROGRAM_ID)
	, FOREIGN KEY (COACH_ID) REFERENCES COACH(COACH_ID) 
) 

CREATE TABLE PAYMENT 
( 
	PAYMENT_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, PAY_METHOD VARCHAR(20) NOT NULL
) 

CREATE TABLE [TRANSACTION] 
( 
	TRANSACTION_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, MEMBER_ID SMALLINT REFERENCES MEMBER(MEMBER_ID) NOT NULL
	, SUB_ID SMALLINT REFERENCES SUBSCRIPTION(SUB_ID) NOT NULL
	, PAYMENT_ID SMALLINT REFERENCES PAYMENT(PAYMENT_ID) NOT NULL
	, TRANSAC_DATE DATE DEFAULT GETDATE() NOT NULL
)

CREATE TABLE TRANSACTION_LOG
(
	LOG_ID SMALLINT PRIMARY KEY IDENTITY(1,1) NOT NULL
	, TRANSACTION_ID INT NOT NULL
	, OPERATION NVARCHAR(15) NOT NULL
	, MODIFIEDDATE DATE DEFAULT GETDATE() NOT NULL
)
